#!/usr/bin/env bash
set -euo pipefail

{{- $root := . -}}
{{- $data := fromToml (include ".chezmoidata.toml") -}}
{{- $defaults := $data.defaults | default (dict) -}}
{{- $uv := (index $defaults "uv") | default (dict) -}}
{{- $pyVersion := (index $uv "python_version") | default "3.12" -}}

# Ensure ~/.local/bin exists and is on PATH for this script.
mkdir -p "$HOME/.local/bin"
export PATH="$HOME/.local/bin:$PATH"

# Install uv if missing.
if ! command -v uv >/dev/null 2>&1; then
  curl -LsSf https://astral.sh/uv/install.sh | sh
  export PATH="$HOME/.local/bin:$PATH"
fi

# Install the desired Python toolchain via uv.
uv python install "{{ $pyVersion }}"

# Determine the Python binary path managed by uv.
PY_BIN="$(uv python path --python {{ $pyVersion }})"
if [ -z "$PY_BIN" ] || [ ! -x "$PY_BIN" ]; then
  echo "Failed to locate uv-managed python for version {{ $pyVersion }}" >&2
  exit 1
fi

PY_DIR="$(dirname "$PY_BIN")"
PIP_BIN="$PY_DIR/pip3"

# Symlink python and pip into ~/.local/bin so they appear before system interpreters.
ln -sf "$PY_BIN" "$HOME/.local/bin/python"
ln -sf "$PY_BIN" "$HOME/.local/bin/python3"
if [ -x "$PIP_BIN" ]; then
  ln -sf "$PIP_BIN" "$HOME/.local/bin/pip"
  ln -sf "$PIP_BIN" "$HOME/.local/bin/pip3"
fi

# Clean up the installer script after completion.
rm -- "$0" >/dev/null 2>&1 || true
