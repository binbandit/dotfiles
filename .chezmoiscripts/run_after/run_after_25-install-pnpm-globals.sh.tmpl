{{- $data := fromToml (include ".chezmoidata.toml") -}}
{{- $defaults := $data.defaults | default (dict) -}}
{{- $pnpm := (index $defaults "pnpm") | default (dict) -}}
{{- $globals := (index $pnpm "global_packages") | default (list) -}}
#!/usr/bin/env bash
set -euo pipefail

if ! command -v pnpm >/dev/null 2>&1; then
  exit 0
fi

case "$(uname -s)" in
  Darwin)
    : "${PNPM_HOME:=$HOME/Library/pnpm}"
    ;;
  *)
    : "${PNPM_HOME:=$HOME/.local/share/pnpm}"
    ;;
esac

export PNPM_HOME
if ! printf '%s' "$PATH" | tr ':' '\n' | grep -Fx "$PNPM_HOME" >/dev/null 2>&1; then
  export PATH="$PNPM_HOME:$PATH"
fi
mkdir -p "$PNPM_HOME"

PACKAGES=(
{{- range $pkg := $globals }}
  {{ printf "%q" $pkg }}
{{- end }}
)

if [ ${#PACKAGES[@]} -eq 0 ]; then
  exit 0
fi

for pkg in "${PACKAGES[@]}"; do
  if ! pnpm ls -g --depth 0 "$pkg" >/dev/null 2>&1; then
    pnpm add -g "$pkg"
  fi
done
